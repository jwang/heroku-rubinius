<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<title>Class: Daemons::Application</title>

	<link rel="stylesheet" href="../rdoc.css" type="text/css" media="screen" />

	<script src="../js/jquery.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/thickbox-compressed.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/quicksearch.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/darkfish.js" type="text/javascript"
		charset="utf-8"></script>

</head>
<body class="class">

	<div id="metadata">
		<div id="home-metadata">
			<div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
			</div>
		</div>

		<div id="file-metadata">
			<div id="file-list-section" class="section">
				<h3 class="section-header">In Files</h3>
				<div class="section-body">
					<ul>
					
						<li><a href="../lib/daemons/application_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
							class="thickbox" title="lib/daemons/application.rb">lib/daemons/application.rb</a></li>
					
					</ul>
				</div>
			</div>

			
		</div>

		<div id="class-metadata">

			<!-- Parent Class -->
			
			<div id="parent-class-section" class="section">
				<h3 class="section-header">Parent</h3>
				
				<p class="link"><a href="../Object.html">Object</a></p>
				
			</div>
			

			<!-- Namespace Contents -->
			

			<!-- Method Quickref -->
			
			<div id="method-list-section" class="section">
				<h3 class="section-header">Methods</h3>
				<ul class="link-list">
					
					<li><a href="#M000000">::new</a></li>
					
					<li><a href="#M000001">#change_privilege</a></li>
					
					<li><a href="#M000014">#exception_log</a></li>
					
					<li><a href="#M000004">#logdir</a></li>
					
					<li><a href="#M000006">#logfile</a></li>
					
					<li><a href="#M000005">#output_logfile</a></li>
					
					<li><a href="#M000003">#pidfile_dir</a></li>
					
					<li><a href="#M000013">#reload</a></li>
					
					<li><a href="#M000019">#running?</a></li>
					
					<li><a href="#M000002">#script</a></li>
					
					<li><a href="#M000018">#show_status</a></li>
					
					<li><a href="#M000011">#start</a></li>
					
					<li><a href="#M000008">#start_exec</a></li>
					
					<li><a href="#M000009">#start_load</a></li>
					
					<li><a href="#M000007">#start_none</a></li>
					
					<li><a href="#M000010">#start_proc</a></li>
					
					<li><a href="#M000012">#started</a></li>
					
					<li><a href="#M000015">#stop</a></li>
					
					<li><a href="#M000016">#zap</a></li>
					
					<li><a href="#M000017">#zap!</a></li>
					
				</ul>
			</div>
			

			<!-- Included Modules -->
			
		</div>

		<div id="project-metadata">
			
			

			<div id="classindex-section" class="section project-section">
				<h3 class="section-header">Class Index
					<span class="search-toggle"><img src="../images/find.png"
						height="16" width="16" alt="[+]"
						title="show/hide quicksearch" /></span></h3>
				<form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
				<fieldset>
					<legend>Quicksearch</legend>
					<input type="text" name="quicksearch" value=""
						class="quicksearch-field" />
				</fieldset>
				</form>

				<ul class="link-list">
				
					<li><a href="../Daemons.html">Daemons</a></li>
				
					<li><a href="../Daemons/Application.html">Daemons::Application</a></li>
				
					<li><a href="../Daemons/ApplicationGroup.html">Daemons::ApplicationGroup</a></li>
				
					<li><a href="../Daemons/CmdException.html">Daemons::CmdException</a></li>
				
					<li><a href="../Daemons/Controller.html">Daemons::Controller</a></li>
				
					<li><a href="../Daemons/Error.html">Daemons::Error</a></li>
				
					<li><a href="../Daemons/Exception.html">Daemons::Exception</a></li>
				
					<li><a href="../Daemons/Monitor.html">Daemons::Monitor</a></li>
				
					<li><a href="../Daemons/Optparse.html">Daemons::Optparse</a></li>
				
					<li><a href="../Daemons/Pid.html">Daemons::Pid</a></li>
				
					<li><a href="../Daemons/PidFile.html">Daemons::PidFile</a></li>
				
					<li><a href="../Daemons/PidMem.html">Daemons::PidMem</a></li>
				
					<li><a href="../Daemons/RuntimeException.html">Daemons::RuntimeException</a></li>
				
					<li><a href="../Daemons/SystemError.html">Daemons::SystemError</a></li>
				
					<li><a href="../CurrentProcess.html">CurrentProcess</a></li>
				
					<li><a href="../Daemonize.html">Daemonize</a></li>
				
					<li><a href="../Object.html">Object</a></li>
				
				</ul>
				<div id="no-class-search-results" style="display: none;">No matching classes.</div>
			</div>

			
		</div>
	</div>

	<div id="documentation">
		<h1 class="class">Daemons::Application</h1>

		<div id="description">
			
		</div>

		<!-- Constants -->
		
		<div id="constants-list" class="section">
			<h3 class="section-header">Constants</h3>
			<dl>
			
				<dt><a name="SIGNAL">SIGNAL</a></dt>
				
				<dd class="description"></dd>
				
			
			</dl>
		</div>
		

		<!-- Attributes -->
		
		<div id="attribute-method-details" class="method-section section">
			<h3 class="section-header">Attributes</h3>

			
			<div id="app-argv-attribute-method" class="method-detail">
				<a name="app_argv"></a>
				
				<a name="app_argv="></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">app_argv</span><span
						class="attribute-access-type">[RW]</span>
				</div>

				<div class="method-description">
				
				
				
				</div>
			</div>
			
			<div id="controller-argv-attribute-method" class="method-detail">
				<a name="controller_argv"></a>
				
				<a name="controller_argv="></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">controller_argv</span><span
						class="attribute-access-type">[RW]</span>
				</div>

				<div class="method-description">
				
				
				
				</div>
			</div>
			
			<div id="pid-attribute-method" class="method-detail">
				<a name="pid"></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">pid</span><span
						class="attribute-access-type">[R]</span>
				</div>

				<div class="method-description">
				
				<p>
the <a href="Pid.html">Pid</a> instance belonging to this application
</p>
				
				</div>
			</div>
			
			<div id="group-attribute-method" class="method-detail">
				<a name="group"></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">group</span><span
						class="attribute-access-type">[R]</span>
				</div>

				<div class="method-description">
				
				<p>
the <a href="ApplicationGroup.html">ApplicationGroup</a> the application
belongs to
</p>
				
				</div>
			</div>
			
			<div id="options-attribute-method" class="method-detail">
				<a name="options"></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">options</span><span
						class="attribute-access-type">[R]</span>
				</div>

				<div class="method-description">
				
				<p>
my private options
</p>
				
				</div>
			</div>
			
		</div>
		

		<!-- Methods -->
		
		<div id="public-instance-method-details" class="method-section section">
			<h3 class="section-header">Public Instance Methods</h3>

		
			<div id="change-privilege-method" class="method-detail ">
				<a name="M000001"></a>

				<div class="method-heading">
				
					<span class="method-name">change_privilege</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="change-privilege-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 48</span>
48:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">change_privilege</span>
49:       <span class="ruby-identifier">user</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
50:       <span class="ruby-identifier">group</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:group</span>]
51:       <span class="ruby-constant">CurrentProcess</span>.<span class="ruby-identifier">change_privilege</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">group</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>
52:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="exception-log-method" class="method-detail ">
				<a name="M000014"></a>

				<div class="method-heading">
				
					<span class="method-name">exception_log</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
This is a nice little function for debugging purposes: In case a
multi-threaded ruby script exits due to an uncaught exception it may be
difficult to find out where the exception came from because one cannot
catch exceptions that are thrown in threads other than the main thread.
</p>
<p>
This function searches for all exceptions in memory and outputs them to
STDERR (if it is connected) and to a log file in the pid-file directory.
</p>
					

					
					<div class="method-source-code"
						id="exception-log-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 338</span>
338:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exception_log</span>
339:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">logfile</span>
340:       
341:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'logger'</span>
342:       
343:       <span class="ruby-identifier">l_file</span> = <span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">logfile</span>)
344:       
345:       <span class="ruby-comment cmt"># the code below finds the last exception</span>
346:       <span class="ruby-identifier">e</span> = <span class="ruby-keyword kw">nil</span>
347:       
348:       <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
349:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">o</span>
350:           <span class="ruby-identifier">e</span> = <span class="ruby-identifier">o</span>
351:         <span class="ruby-keyword kw">end</span>
352:       }
353:      
354:       <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;*** below you find the most recent exception thrown, this will be likely (but not certainly) the exception that made the application exit abnormally ***&quot;</span>
355:       <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">e</span>
356:       
357:       <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;*** below you find all exception objects found in memory, some of them may have been thrown in your application, others may just be in memory because they are standard exceptions ***&quot;</span>
358:       
359:       <span class="ruby-comment cmt"># this code logs every exception found in memory</span>
360:       <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
361:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">o</span>
362:           <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">o</span>
363:         <span class="ruby-keyword kw">end</span>
364:       }
365:       
366:       <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">close</span>
367:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="logdir-method" class="method-detail ">
				<a name="M000004"></a>

				<div class="method-heading">
				
					<span class="method-name">logdir</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="logdir-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 62</span>
62:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">logdir</span>
63:       <span class="ruby-identifier">logdir</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:log_dir</span>]
64:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">logdir</span>
65:         <span class="ruby-identifier">logdir</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:dir_mode</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:system</span> <span class="ruby-operator">?</span> <span class="ruby-value str">'/var/log'</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">pidfile_dir</span>
66:       <span class="ruby-keyword kw">end</span>
67:       <span class="ruby-identifier">logdir</span>
68:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="logfile-method" class="method-detail ">
				<a name="M000006"></a>

				<div class="method-heading">
				
					<span class="method-name">logfile</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="logfile-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 74</span>
74:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">logfile</span>
75:       <span class="ruby-identifier">logdir</span> <span class="ruby-operator">?</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">logdir</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'.log'</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
76:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="output-logfile-method" class="method-detail ">
				<a name="M000005"></a>

				<div class="method-heading">
				
					<span class="method-name">output_logfile</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="output-logfile-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 70</span>
70:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">output_logfile</span>
71:       (<span class="ruby-identifier">options</span>[<span class="ruby-value">:log_output</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">logdir</span>) <span class="ruby-operator">?</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">logdir</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'.output'</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
72:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="pidfile-dir-method" class="method-detail ">
				<a name="M000003"></a>

				<div class="method-heading">
				
					<span class="method-name">pidfile_dir</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="pidfile-dir-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 58</span>
58:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pidfile_dir</span>
59:       <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">dir</span>(<span class="ruby-ivar">@dir_mode</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">dir_mode</span>, <span class="ruby-ivar">@dir</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">dir</span>, <span class="ruby-ivar">@script</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">script</span>)
60:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="reload-method" class="method-detail ">
				<a name="M000013"></a>

				<div class="method-heading">
				
					<span class="method-name">reload</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
def run
</p>
<pre>
  if @group.controller.options[:exec]
    run_via_exec()
  else
    run_via_load()
  end
</pre>
<p>
end
</p>
<pre>
 
</pre>
<p>
def run_via_exec
</p>
<pre>
  
</pre>
<p>
end
</p>
<p>
def run_via_load
</p>
<pre>
  
</pre>
<p>
end
</p>
					

					
					<div class="method-source-code"
						id="reload-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 323</span>
323:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reload</span>
324:       <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'HUP'</span>, <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>)
325:     <span class="ruby-keyword kw">rescue</span>
326:       <span class="ruby-comment cmt"># ignore</span>
327:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="running--method" class="method-detail ">
				<a name="M000019"></a>

				<div class="method-heading">
				
					<span class="method-name">running?</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
This function implements a (probably too simle) method to detect whether
the program with the pid found in the pid-file is still running. It just
searches for the pid in the output of <tt>ps ax</tt>, which is probably not
a good idea in some cases. Alternatives would be to use a direct access
method the unix process control system.
</p>
					

					
					<div class="method-source-code"
						id="running--source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 458</span>
458:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">running?</span>
459:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">exist?</span>
460:         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">running?</span>(<span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>)
461:       <span class="ruby-keyword kw">end</span>
462:       
463:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
464:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="script-method" class="method-detail ">
				<a name="M000002"></a>

				<div class="method-heading">
				
					<span class="method-name">script</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="script-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 54</span>
54:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">script</span>
55:       <span class="ruby-ivar">@script</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">script</span>
56:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="show-status-method" class="method-detail ">
				<a name="M000018"></a>

				<div class="method-heading">
				
					<span class="method-name">show_status</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="show-status-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 445</span>
445:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show_status</span>
446:       <span class="ruby-identifier">running</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">running?</span>
447:       
448:       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: #{running ? '' : 'not '}running#{(running and @pid.exist?) ? ' [pid ' + @pid.pid.to_s + ']' : ''}#{(@pid.exist? and not running) ? ' (but pid-file exists: ' + @pid.pid.to_s + ')' : ''}&quot;</span>
449:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="start-method" class="method-detail ">
				<a name="M000011"></a>

				<div class="method-heading">
				
					<span class="method-name">start</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="start-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 280</span>
280:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>
281:       <span class="ruby-identifier">change_privilege</span>
282:       <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">create_monitor</span>(<span class="ruby-ivar">@group</span>.<span class="ruby-identifier">applications</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>]  <span class="ruby-comment cmt"># we don't monitor applications in the foreground</span>
283:       
284:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:mode</span>]
285:         <span class="ruby-keyword kw">when</span> <span class="ruby-value">:none</span>
286:           <span class="ruby-comment cmt"># this is only used to daemonize the currently running process</span>
287:           <span class="ruby-identifier">start_none</span>
288:         <span class="ruby-keyword kw">when</span> <span class="ruby-value">:exec</span>
289:           <span class="ruby-identifier">start_exec</span>
290:         <span class="ruby-keyword kw">when</span> <span class="ruby-value">:load</span>
291:           <span class="ruby-identifier">start_load</span>
292:         <span class="ruby-keyword kw">when</span> <span class="ruby-value">:proc</span>
293:           <span class="ruby-identifier">start_proc</span>
294:         <span class="ruby-keyword kw">else</span>
295:           <span class="ruby-identifier">start_load</span>
296:       <span class="ruby-keyword kw">end</span>
297:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="start-exec-method" class="method-detail ">
				<a name="M000008"></a>

				<div class="method-heading">
				
					<span class="method-name">start_exec</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="start-exec-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 122</span>
122:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_exec</span>
123:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:backtrace</span>]
124:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;option :backtrace is not supported with :mode =&gt; :exec, ignoring&quot;</span>
125:       <span class="ruby-keyword kw">end</span>
126:       
127:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>]
128:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">output_logfile</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span>)
129:       <span class="ruby-keyword kw">else</span>
130:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">output_logfile</span>)
131:       <span class="ruby-keyword kw">end</span>
132:       
133:       <span class="ruby-comment cmt"># note that we cannot remove the pid file if we run in :ontop mode (i.e. 'ruby ctrl_exec.rb run')</span>
134:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
135:       
136:       <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'DAEMONS_ARGV'</span>] = <span class="ruby-ivar">@controller_argv</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>)      
137:       <span class="ruby-comment cmt"># haven't tested yet if this is really passed to the exec'd process...</span>
138:       
139:       <span class="ruby-identifier">started</span>()
140:       <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">exec</span>(<span class="ruby-identifier">script</span>(), *(<span class="ruby-ivar">@app_argv</span> <span class="ruby-operator">||</span> []))
141:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="start-load-method" class="method-detail ">
				<a name="M000009"></a>

				<div class="method-heading">
				
					<span class="method-name">start_load</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="start-load-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 143</span>
143:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_load</span>
144:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>]
145:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">output_logfile</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span>)
146:       <span class="ruby-keyword kw">else</span>
147:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">output_logfile</span>)
148:       <span class="ruby-keyword kw">end</span>
149:       
150:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
151:       
152:       
153:       <span class="ruby-comment cmt"># We need this to remove the pid-file if the applications exits by itself.</span>
154:       <span class="ruby-comment cmt"># Note that &lt;tt&gt;at_exit&lt;/tt&gt; will only be run if the applications exits by calling </span>
155:       <span class="ruby-comment cmt"># &lt;tt&gt;exit&lt;/tt&gt;, and not if it calls &lt;tt&gt;exit!&lt;/tt&gt; (so please don't call &lt;tt&gt;exit!&lt;/tt&gt;</span>
156:       <span class="ruby-comment cmt"># in your application!</span>
157:       <span class="ruby-comment cmt">#</span>
158:       <span class="ruby-identifier">at_exit</span> {
159:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
160:         
161:         <span class="ruby-comment cmt"># If the option &lt;tt&gt;:backtrace&lt;/tt&gt; is used and the application did exit by itself</span>
162:         <span class="ruby-comment cmt"># create a exception log.</span>
163:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:backtrace</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$daemons_sigterm</span>
164:           <span class="ruby-keyword kw">begin</span>; <span class="ruby-identifier">exception_log</span>(); <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
165:         <span class="ruby-keyword kw">end</span>
166:           
167:       }
168:       
169:       <span class="ruby-comment cmt"># This part is needed to remove the pid-file if the application is killed by </span>
170:       <span class="ruby-comment cmt"># daemons or manually by the user.</span>
171:       <span class="ruby-comment cmt"># Note that the applications is not supposed to overwrite the signal handler for</span>
172:       <span class="ruby-comment cmt"># 'TERM'.</span>
173:       <span class="ruby-comment cmt">#</span>
174:       <span class="ruby-identifier">$daemons_stop_proc</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:stop_proc</span>]
175:       <span class="ruby-identifier">trap</span>(<span class="ruby-constant">SIGNAL</span>) {
176:         <span class="ruby-keyword kw">begin</span>
177:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$daemons_stop_proc</span>
178:           <span class="ruby-identifier">$daemons_stop_proc</span>.<span class="ruby-identifier">call</span>
179:         <span class="ruby-keyword kw">end</span>
180:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
181:         <span class="ruby-keyword kw">end</span>
182:         
183:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
184:         <span class="ruby-identifier">$daemons_sigterm</span> = <span class="ruby-keyword kw">true</span>
185:         
186:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:hard_exit</span>]
187:           <span class="ruby-identifier">exit!</span>
188:         <span class="ruby-keyword kw">else</span>
189:           <span class="ruby-identifier">exit</span>
190:         <span class="ruby-keyword kw">end</span>
191:       }
192:       
193:       <span class="ruby-comment cmt"># Now we really start the script...</span>
194:       <span class="ruby-identifier">$DAEMONS_ARGV</span> = <span class="ruby-ivar">@controller_argv</span>
195:       <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'DAEMONS_ARGV'</span>] = <span class="ruby-ivar">@controller_argv</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>)
196:       
197:       <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">clear</span>
198:       <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">concat</span> <span class="ruby-ivar">@app_argv</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@app_argv</span>
199:       
200:       <span class="ruby-identifier">started</span>()
201:       <span class="ruby-comment cmt"># TODO: begin - rescue - end around this and exception logging</span>
202:       <span class="ruby-identifier">load</span> <span class="ruby-identifier">script</span>()
203:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="start-none-method" class="method-detail ">
				<a name="M000007"></a>

				<div class="method-heading">
				
					<span class="method-name">start_none</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
this function is only used to daemonize the currently running process (<a
href="../Daemons.html#M000079">Daemons.daemonize</a>)
</p>
					

					
					<div class="method-source-code"
						id="start-none-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 79</span>
 79:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_none</span>
 80:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>]
 81:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">output_logfile</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span>)
 82:       <span class="ruby-keyword kw">else</span>
 83:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">output_logfile</span>)
 84:       <span class="ruby-keyword kw">end</span>
 85:       
 86:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
 87:       
 88:       
 89:       <span class="ruby-comment cmt"># We need this to remove the pid-file if the applications exits by itself.</span>
 90:       <span class="ruby-comment cmt"># Note that &lt;tt&gt;at_text&lt;/tt&gt; will only be run if the applications exits by calling </span>
 91:       <span class="ruby-comment cmt"># &lt;tt&gt;exit&lt;/tt&gt;, and not if it calls &lt;tt&gt;exit!&lt;/tt&gt; (so please don't call &lt;tt&gt;exit!&lt;/tt&gt;</span>
 92:       <span class="ruby-comment cmt"># in your application!</span>
 93:       <span class="ruby-comment cmt">#</span>
 94:       <span class="ruby-identifier">at_exit</span> {
 95:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
 96:         
 97:         <span class="ruby-comment cmt"># If the option &lt;tt&gt;:backtrace&lt;/tt&gt; is used and the application did exit by itself</span>
 98:         <span class="ruby-comment cmt"># create a exception log.</span>
 99:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:backtrace</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$daemons_sigterm</span>
100:           <span class="ruby-keyword kw">begin</span>; <span class="ruby-identifier">exception_log</span>(); <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
101:         <span class="ruby-keyword kw">end</span>
102:           
103:       }
104:       
105:       <span class="ruby-comment cmt"># This part is needed to remove the pid-file if the application is killed by </span>
106:       <span class="ruby-comment cmt"># daemons or manually by the user.</span>
107:       <span class="ruby-comment cmt"># Note that the applications is not supposed to overwrite the signal handler for</span>
108:       <span class="ruby-comment cmt"># 'TERM'.</span>
109:       <span class="ruby-comment cmt">#</span>
110:       <span class="ruby-identifier">trap</span>(<span class="ruby-constant">SIGNAL</span>) {
111:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
112:         <span class="ruby-identifier">$daemons_sigterm</span> = <span class="ruby-keyword kw">true</span>
113:         
114:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:hard_exit</span>]
115:           <span class="ruby-identifier">exit!</span>
116:         <span class="ruby-keyword kw">else</span>
117:           <span class="ruby-identifier">exit</span>
118:         <span class="ruby-keyword kw">end</span>
119:       }
120:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="start-proc-method" class="method-detail ">
				<a name="M000010"></a>

				<div class="method-heading">
				
					<span class="method-name">start_proc</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="start-proc-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 205</span>
205:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_proc</span>
206:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">p</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:proc</span>]
207:     
208:       <span class="ruby-identifier">myproc</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword kw">do</span> 
209:         <span class="ruby-comment cmt"># We need this to remove the pid-file if the applications exits by itself.</span>
210:         <span class="ruby-comment cmt"># Note that &lt;tt&gt;at_text&lt;/tt&gt; will only be run if the applications exits by calling </span>
211:         <span class="ruby-comment cmt"># &lt;tt&gt;exit&lt;/tt&gt;, and not if it calls &lt;tt&gt;exit!&lt;/tt&gt; (so please don't call &lt;tt&gt;exit!&lt;/tt&gt;</span>
212:         <span class="ruby-comment cmt"># in your application!</span>
213:         <span class="ruby-comment cmt">#</span>
214:         <span class="ruby-identifier">at_exit</span> {
215:           <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
216: 
217:           <span class="ruby-comment cmt"># If the option &lt;tt&gt;:backtrace&lt;/tt&gt; is used and the application did exit by itself</span>
218:           <span class="ruby-comment cmt"># create a exception log.</span>
219:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:backtrace</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$daemons_sigterm</span>
220:             <span class="ruby-keyword kw">begin</span>; <span class="ruby-identifier">exception_log</span>(); <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
221:           <span class="ruby-keyword kw">end</span>
222: 
223:         }
224: 
225:         <span class="ruby-comment cmt"># This part is needed to remove the pid-file if the application is killed by </span>
226:         <span class="ruby-comment cmt"># daemons or manually by the user.</span>
227:         <span class="ruby-comment cmt"># Note that the applications is not supposed to overwrite the signal handler for</span>
228:         <span class="ruby-comment cmt"># 'TERM'.</span>
229:         <span class="ruby-comment cmt">#</span>
230:         <span class="ruby-identifier">$daemons_stop_proc</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:stop_proc</span>]
231:         <span class="ruby-identifier">trap</span>(<span class="ruby-constant">SIGNAL</span>) {
232:           <span class="ruby-keyword kw">begin</span>
233:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$daemons_stop_proc</span>
234:             <span class="ruby-identifier">$daemons_stop_proc</span>.<span class="ruby-identifier">call</span>
235:           <span class="ruby-keyword kw">end</span>
236:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
237:           <span class="ruby-keyword kw">end</span>
238:           
239:           <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
240:           <span class="ruby-identifier">$daemons_sigterm</span> = <span class="ruby-keyword kw">true</span>
241: 
242:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:hard_exit</span>]
243:             <span class="ruby-identifier">exit!</span>
244:           <span class="ruby-keyword kw">else</span>
245:             <span class="ruby-identifier">exit</span>
246:           <span class="ruby-keyword kw">end</span>
247:         }
248:         
249:         <span class="ruby-identifier">p</span>.<span class="ruby-identifier">call</span>()
250:       <span class="ruby-keyword kw">end</span>
251:       
252:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ontop</span>]
253:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">call_as_daemon</span>(<span class="ruby-identifier">myproc</span>, <span class="ruby-identifier">output_logfile</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span>)
254:         
255:       <span class="ruby-keyword kw">else</span>
256:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">output_logfile</span>)
257:         
258:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
259:         
260:         <span class="ruby-identifier">myproc</span>.<span class="ruby-identifier">call</span>
261:         
262: <span class="ruby-comment cmt"># why did we use this??</span>
263: <span class="ruby-comment cmt">#         Thread.new(&amp;options[:proc])</span>
264: 
265: <span class="ruby-comment cmt"># why did we use the code below??</span>
266:         <span class="ruby-comment cmt"># unless pid = Process.fork</span>
267:         <span class="ruby-comment cmt">#   @pid.pid = pid</span>
268:         <span class="ruby-comment cmt">#   Daemonize.simulate(logfile)</span>
269:         <span class="ruby-comment cmt">#   options[:proc].call</span>
270:         <span class="ruby-comment cmt">#   exit</span>
271:         <span class="ruby-comment cmt"># else</span>
272:         <span class="ruby-comment cmt">#   Process.detach(@pid.pid)</span>
273:         <span class="ruby-comment cmt"># end</span>
274:       <span class="ruby-keyword kw">end</span>
275:       
276:       <span class="ruby-identifier">started</span>()
277:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="started-method" class="method-detail ">
				<a name="M000012"></a>

				<div class="method-heading">
				
					<span class="method-name">started</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="started-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 299</span>
299:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">started</span>
300:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>
301:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: process with pid #{pid} started.&quot;</span>
302:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
303:       <span class="ruby-keyword kw">end</span>
304:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="stop-method" class="method-detail ">
				<a name="M000015"></a>

				<div class="method-heading">
				
					<span class="method-name">stop</span><span
						class="method-args">(no_wait = false)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="stop-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 370</span>
370:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop</span>(<span class="ruby-identifier">no_wait</span> = <span class="ruby-keyword kw">false</span>)
371:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">running?</span>
372:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">zap</span>
373:         <span class="ruby-keyword kw">return</span>
374:       <span class="ruby-keyword kw">end</span>
375:       
376:       <span class="ruby-identifier">pid</span> = <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>
377:       
378:       <span class="ruby-comment cmt"># Catch errors when trying to kill a process that doesn't</span>
379:       <span class="ruby-comment cmt"># exist. This happens when the process quits and hasn't been</span>
380:       <span class="ruby-comment cmt"># restarted by the monitor yet. By catching the error, we allow the</span>
381:       <span class="ruby-comment cmt"># pid file clean-up to occur.</span>
382:       <span class="ruby-keyword kw">begin</span>
383:         <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-constant">SIGNAL</span>, <span class="ruby-identifier">pid</span>)
384:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ESRCH</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
385:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{e} #{pid}&quot;</span>
386:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;deleting pid-file.&quot;</span>
387:       <span class="ruby-keyword kw">end</span>
388:       
389:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">no_wait</span>
390:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@force_kill_waittime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
391:           <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: trying to stop process with pid #{pid}...&quot;</span>
392:           <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
393:           
394:           <span class="ruby-keyword kw">begin</span>
395:             <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@force_kill_waittime</span>) {
396:               <span class="ruby-keyword kw">while</span> <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">running?</span>(<span class="ruby-identifier">pid</span>)
397:                 <span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.2</span>)
398:               <span class="ruby-keyword kw">end</span>
399:             }
400:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
401:             <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: process with pid #{pid} won't stop, we forcefully kill it...&quot;</span>
402:             <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
403:             
404:             <span class="ruby-keyword kw">begin</span>
405:               <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'KILL'</span>, <span class="ruby-identifier">pid</span>)
406:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ESRCH</span>
407:             <span class="ruby-keyword kw">end</span>
408:             
409:             <span class="ruby-keyword kw">begin</span>
410:               <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>(<span class="ruby-value">20</span>) {
411:                 <span class="ruby-keyword kw">while</span> <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">running?</span>(<span class="ruby-identifier">pid</span>)
412:                   <span class="ruby-identifier">sleep</span>(<span class="ruby-value">1</span>)
413:                 <span class="ruby-keyword kw">end</span>
414:               }
415:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
416:               <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: unable to forcefully kill process with pid #{pid}.&quot;</span>
417:               <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
418:             <span class="ruby-keyword kw">end</span>
419:           <span class="ruby-keyword kw">end</span>
420:         <span class="ruby-keyword kw">end</span>
421:         
422:         
423:       <span class="ruby-keyword kw">end</span>
424:       
425:       <span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
426:       <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">running?</span>(<span class="ruby-identifier">pid</span>)
427:         <span class="ruby-comment cmt"># We try to remove the pid-files by ourselves, in case the application</span>
428:         <span class="ruby-comment cmt"># didn't clean it up.</span>
429:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
430:         
431:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: process with pid #{pid} successfully stopped.&quot;</span>
432:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
433:       <span class="ruby-keyword kw">end</span>
434:       
435:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="zap-method" class="method-detail ">
				<a name="M000016"></a>

				<div class="method-heading">
				
					<span class="method-name">zap</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="zap-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 437</span>
437:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">zap</span>
438:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>
439:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="zap--method" class="method-detail ">
				<a name="M000017"></a>

				<div class="method-heading">
				
					<span class="method-name">zap!</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="zap--source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 441</span>
441:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">zap!</span>
442:       <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
443:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
		</div>
	
		<div id="public-class-method-details" class="method-section section">
			<h3 class="section-header">Public Class Methods</h3>

		
			<div id="new-method" class="method-detail ">
				<a name="M000000"></a>

				<div class="method-heading">
				
					<span class="method-name">new</span><span
						class="method-args">(group, add_options = {}, pid = nil)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="new-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 28</span>
28:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">group</span>, <span class="ruby-identifier">add_options</span> = {}, <span class="ruby-identifier">pid</span> = <span class="ruby-keyword kw">nil</span>)
29:       <span class="ruby-ivar">@group</span> = <span class="ruby-identifier">group</span>
30:       <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">group</span>.<span class="ruby-identifier">options</span>.<span class="ruby-identifier">dup</span>
31:       <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">add_options</span>)
32:       
33:       <span class="ruby-ivar">@dir_mode</span> = <span class="ruby-ivar">@dir</span> = <span class="ruby-ivar">@script</span> = <span class="ruby-keyword kw">nil</span>
34:       
35:       <span class="ruby-ivar">@force_kill_waittime</span> = <span class="ruby-ivar">@options</span>[<span class="ruby-value">:force_kill_waittime</span>] <span class="ruby-operator">||</span> <span class="ruby-value">20</span>
36:       
37:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@pid</span> = <span class="ruby-identifier">pid</span>
38:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@options</span>[<span class="ruby-value">:no_pidfiles</span>]
39:           <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">PidMem</span>.<span class="ruby-identifier">new</span>
40:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">dir</span> = <span class="ruby-identifier">pidfile_dir</span>
41:           <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">PidFile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">dir</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">multiple</span>)
42:         <span class="ruby-keyword kw">else</span>
43:           <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">PidMem</span>.<span class="ruby-identifier">new</span>
44:         <span class="ruby-keyword kw">end</span>
45:       <span class="ruby-keyword kw">end</span>
46:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
		</div>
	

	</div>


	<div id="rdoc-debugging-section-dump" class="debugging-section">
	
		<p>Disabled; run with --debug to generate this.</p>
	
	</div>

	<div id="validator-badges">
		<p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
		<p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
			Rdoc Generator</a> 1.1.6</small>.</p>
	</div>

</body>
</html>

